<!DOCTYPE html>
<html>
 <head>
  <title>WEBNEWS by Applh.com</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

   <link rel="stylesheet" href="jquery-mobile.css">
   <style type="text/css">
body {
   width:100%;
   height:100%;
   margin:0;
   padding:0;
}
.page {
   margin:0 auto;
}
.header .title {
   color:#abcdef;
   padding:0px 15px;
}
.banner {
   background-color:#abcdef;
   padding:15px 15px;
}
.content {
   padding:15px 15px;
}
   </style>

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="jquery-mobile.js"></script>
   <script src="phonegap.js"></script>

   <script type="text/javascript" charset="utf-8">
var WN={};

WN.app_active="";
WN.init_jquery=function() {
   //WN.debug("JQUERY start");

   WN.debug=function(msg) {
      WN.debug_step++;
      jQuery("#debug-info").prepend('<div>'+WN.debug_step+'. '+msg+'</div>');
   };

   // search click
   jQuery("#act-ok").click(WN.act_search);

   //WN.debug("JQUERY end");
};

WN.act_search=function () {
   WN.app_active=jQuery.trim(jQuery("#app-search").val());
   // load home page
   window.location.replace("#home");
   // load app
   WN.init_app();
};


WN.phonegap_ok=false;
WN.init_phonegap=function() {
   WN.debug("device ready");
   WN.debug("file system checking...");
   // FILE SYSTEM NEEDED TO STORE DATA
   window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, WN.init_FS_ready, WN.init_FS_fail);
};

WN.init_app=function() {
 
   WN.debug("Loading... " + WN.app_active);
   
   WN.server_uri= '/app=' + WN.app_active + '/';

   // TIMER TEST
   //window.setInterval(function(){var d = new Date();WN.debug("TIMER INTERVAL TEST..."+ d.toUTCString());}, 60000);
   //window.setTimeout(function(){var d = new Date();WN.debug("TIMER TIMEOUT TEST..."+ d.toUTCString());}, 5000);

   // FIRST APP LOADING
   WN.server_download();

   // ACTIVATE WEB SERVICE
   WN.web_service_on(10000);

};

WN.device_platform="";
WN.device_uuid="";
WN.get_device_info=function () {

   if (!WN.phonegap_ok) {
      WN.debug("phonegap not ready...");
      return "";
   }

   WN.device_platform=device.platform;
   WN.device_uuid=device.uuid;

   var dihtml = 'Device Name: '     + device.name     + '<br />' + 
                'Device Cordova: '  + device.cordova + '<br />' + 
                'Device Platform: ' + device.platform + '<br />' + 
                'Device UUID: '     + device.uuid     + '<br />' + 
                'Device Version: '  + device.version  + '<br />';
   WN.debug(dihtml);
   return dihtml;
};

WN.gap_geoid=null;
WN.geo_service_on=function () {
   if (!WN.phonegap_ok) {
      WN.debug("phonegap not ready...");
      return;
   }

   // GEO LOCATION
   // Get the most accurate position updates available on the device.
   var geo_options = { enableHighAccuracy: true };
   if (WN.gap_geoid == null) {
      WN.gap_geoid = navigator.geolocation.watchPosition(WN.geo_ok, WN.geo_error, geo_options);
   }
};
WN.geo_service_off=function () {
   if (WN.gap_geoid != null) {
      navigator.geolocation.clearWatch(WN.gap_geoid);
      WN.gap_geoid = null;
   }
};

WN.server_loop=null;
WN.server_period=10000;
WN.web_service_on=function (period) {
   if (WN.server_loop != null) {
      clearInterval(WN.server_loop);
      WN.server_loop=null;
   }
   if (period > 1000) {
      WN.server_period=period;
      WN.server_loop=window.setInterval(function(){WN.server_download();}, WN.server_period);
   }
};


WN.gap_root=null;
WN.bname_cache="webnews.txt";
WN.server_url="http://webnews.applh.com";
WN.server_uri="/";
WN.init_FS_ready=function (fileSystem) {
   WN.debug("file webnews.txt");
   WN.gap_root=fileSystem.root;
   WN.gap_root.getFile(WN.bname_cache, {create: true, exclusive: false}, WN.init_FS_prepare, WN.init_FS_fail);
   
   WN.phonegap_ok=true;
   // read device info
   WN.get_device_info();

   WN.debug("server download");
   WN.file_cache=fileSystem.root.fullPath+"/"+WN.bname_cache;
   WN.server_download();   
};
WN.init_FS_prepare=function (fileEntry) {
   WN.debug("create writer");
   fileEntry.createWriter(WN.init_FS_start, WN.init_FS_fail);
};
WN.init_FS_start=function (writer) {
   WN.debug("write into file");
   writer.write(WN.server_url+WN.server_uri);
};

WN.server_download=function() {
   if (!WN.phonegap_ok) {
      WN.debug("phonegap not ready...");
      return;
   }

   // !! Assumes filePath is a valid path on the device
   filePath=WN.file_cache;
   var fileTransfer = new FileTransfer();
   var uri = encodeURI(WN.server_url+WN.server_uri);

   fileTransfer.download(
    uri,
    filePath,
    function(entry) {
        //WN.debug("download complete: " + entry.fullPath);
        WN.file_config_load();        
    },
    function(error) {
        WN.debug("download error source " + error.source);
        WN.debug("download error target " + error.target);
        WN.debug("upload error code" + error.code);
    }
   );
};

WN.file_config_load=function () {
   //WN.debug("LOAD CONFIG FILE");
   WN.gap_root.getFile(WN.bname_cache, {create: true, exclusive: false}, WN.config_prepare, WN.init_FS_fail);
};
WN.config_prepare=function(fileEntry) {
   //WN.debug("CONFIG... file entry");
   fileEntry.file(WN.config_read, WN.init_FS_fail);
};
WN.config_read=function(file) {
   //WN.debug("CONFIG... file reader");

   var reader = new FileReader();
   reader.onloadend = function (evt) {
      //WN.debug("CONFIG... read as text");
      WN.config_text=evt.target.result;
      WN.debug(WN.config_text);
   };
   reader.readAsText(file);
};

WN.init_FS_fail=function (evt) {
   WN.debug(evt.target.error.code);
};

WN.debug_step=0;
WN.debug=function(msg) {
  WN.debug_step++;
  //alert(WN.debug_step + '. ' +msg);
  var element = document.getElementById('debug-info');
  element.innerHTML+='<div>'+WN.debug_step+'. '+msg+'</div>';
};


WN.geo_ok=function (position) {
   var msg='';
   msg= 'Latitude: '           + position.coords.latitude              + '<br />' +
        'Longitude: '          + position.coords.longitude             + '<br />' +
        'Altitude: '           + position.coords.altitude              + '<br />' +
        'Accuracy: '           + position.coords.accuracy              + '<br />' +
        'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
        'Heading: '            + position.coords.heading               + '<br />' +
        'Speed: '              + position.coords.speed                 + '<br />' +
        'Timestamp: '          + position.timestamp          + '<br />';

   WN.debug(msg);
   WN.server_uri= ''
                 +'/app='+WN.app_active
                 +'/lat='+position.coords.latitude
                 +'/lon='+position.coords.longitude
                 +'/alt='+position.coords.altitude
                 +'/speed='+position.coords.speed
                 +'/accu='+position.coords.accuracy
                 +'/time='+position.timestamp
                 +'/';
};

WN.geo_error=function (error) {
   var msg='code: '+ error.code+ ', message: ' + error.message;
   WN.debug(msg);         
};


// Wait for Cordova to load
document.addEventListener("deviceready", WN.init_phonegap, false);
// Wait for jQuery to load
jQuery(WN.init_jquery);


   </script>
 </head>
 <body>
  <!--LOGIN-START-->
  <div id="start" data-role="page" class="page">
<div data-role="header" class="header">
 <div class="title">
  <h1>Start</h1>
 </div>
 <div class="banner">
  <div class="device-zone">
<fieldset class="ui-grid-a" style="max-width:640px;">
    <div class="ui-block-a"><input name="app-name" id="app-search" value="" placeholder="..." type="search"></div>
    <div class="ui-block-b" style=""><input name="app-ok" id="act-ok" value="OK" type="button"></div>
</fieldset>
  </div>
 </div>
</div>
<div data-role="content" class="content">
 <div class="server-zone"></div>
</div>
<div data-role="footer" class="footer">
</div>
  </div>
  <!--LOGIN-END-->
  <!--HOME-START-->
  <div id="home" data-role="page" class="page">
<div data-role="header" class="header">
 <div class="title">
  <h1>WebNews</h1>
 </div>
 <div class="banner">
  <div id="device-info"></div>
 </div>
</div>
<div data-role="content" class="content">
 <div id="debug-info"></div>
</div>
<div data-role="footer" class="footer">
</div>
  </div>
  <!--HOME-END-->
 </body>
</html>
