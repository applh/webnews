<!DOCTYPE html>
<html>
 <head>
  <title>WEBNEWS by Applh.com</title>

   <link rel="stylesheet" href="jquery-mobile.css">

   <script type="text/javascript" src="jquery.js"></script>
   <script type="text/javascript" src="jquery-mobile.js"></script>
   <script src="phonegap.js"></script>

   <script type="text/javascript" charset="utf-8">
var WN={};

WN.init_jquery=function() {
   WN.debug("JQUERY start");

   WN.debug=function(msg) {
      WN.debug_step++;
      jQuery("#debug-info").append('<div>'+WN.debug_step+'. '+msg+'</div>');
   };

   WN.debug("JQUERY end");
};
jQuery(WN.init_jquery);

WN.init_phonegap=function() {
 
   WN.debug("DEVICE READY");

   WN.debug("DEVICE INFO");
   var element = document.getElementById('device-info');
   element.innerHTML = 'Device Name: '     + device.name     + '<br />' + 
                            'Device Cordova: '  + device.cordova + '<br />' + 
                            'Device Platform: ' + device.platform + '<br />' + 
                            'Device UUID: '     + device.uuid     + '<br />' + 
                            'Device Version: '  + device.version  + '<br />';

   WN.debug("FILE SYSTEM");
   window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, WN.init_FS_ready, WN.init_FS_fail);
   
   // TIMER TEST
   window.setInterval(function(){var d = new Date();WN.debug("TIMER INTERVAL TEST..."+ d.toUTCString());}, 60000);
   window.setTimeout(function(){var d = new Date();WN.debug("TIMER TIMEOUT TEST..."+ d.toUTCString());}, 5000);
   window.setInterval(function(){WN.server_download();}, 5000);

   // GEO LOCATION
   // Get the most accurate position updates available on the
   // device.
   var geo_options = { enableHighAccuracy: true };
   WN.gap_geoid = navigator.geolocation.watchPosition(WN.geo_ok, WN.geo_error, geo_options);

};

WN.gap_root=null;
WN.bname_cache="webnews.txt";
WN.server_url="http://webnews.applh.com";
WN.server_uri="/";
WN.init_FS_ready=function (fileSystem) {
   WN.debug("file webnews.txt");
   WN.gap_root=fileSystem.root;
   WN.gap_root.getFile(WN.bname_cache, {create: true, exclusive: false}, WN.init_FS_prepare, WN.init_FS_fail);
   
   WN.debug("server download");
   WN.file_cache=fileSystem.root.fullPath+"/"+WN.bname_cache;
   WN.server_download();   
};
WN.init_FS_prepare=function (fileEntry) {
   WN.debug("create writer");
   fileEntry.createWriter(WN.init_FS_start, WN.init_FS_fail);
};
WN.init_FS_start=function (writer) {
   WN.debug("write into file");
   writer.write(WN.server_url+WN.server_uri);
};

WN.server_download=function() {
   // !! Assumes filePath is a valid path on the device
   filePath=WN.file_cache;
   var fileTransfer = new FileTransfer();
   var uri = encodeURI(WN.server_url+WN.server_uri);

   fileTransfer.download(
    uri,
    filePath,
    function(entry) {
        //WN.debug("download complete: " + entry.fullPath);
        WN.file_config_load();        
    },
    function(error) {
        WN.debug("download error source " + error.source);
        WN.debug("download error target " + error.target);
        WN.debug("upload error code" + error.code);
    }
   );
};

WN.file_config_load=function () {
   //WN.debug("LOAD CONFIG FILE");
   WN.gap_root.getFile(WN.bname_cache, {create: true, exclusive: false}, WN.config_prepare, WN.init_FS_fail);
};
WN.config_prepare=function(fileEntry) {
   //WN.debug("CONFIG... file entry");
   fileEntry.file(WN.config_read, WN.init_FS_fail);
};
WN.config_read=function(file) {
   //WN.debug("CONFIG... file reader");

   var reader = new FileReader();
   reader.onloadend = function (evt) {
      //WN.debug("CONFIG... read as text");
      WN.config_text=evt.target.result;
      WN.debug(WN.config_text);
   };
   reader.readAsText(file);
};

WN.init_FS_fail=function (evt) {
   WN.debug(evt.target.error.code);
};

WN.debug_step=0;
WN.debug=function(msg) {
  WN.debug_step++;
  //alert(WN.debug_step + '. ' +msg);
  var element = document.getElementById('debug-info');
  element.innerHTML+='<div>'+WN.debug_step+'. '+msg+'</div>';
};


WN.geo_ok=function (position) {
   var msg='';
   msg= 'Latitude: '           + position.coords.latitude              + '<br />' +
        'Longitude: '          + position.coords.longitude             + '<br />' +
        'Altitude: '           + position.coords.altitude              + '<br />' +
        'Accuracy: '           + position.coords.accuracy              + '<br />' +
        'Altitude Accuracy: '  + position.coords.altitudeAccuracy      + '<br />' +
        'Heading: '            + position.coords.heading               + '<br />' +
        'Speed: '              + position.coords.speed                 + '<br />' +
        'Timestamp: '          + position.timestamp          + '<br />';

   WN.debug(msg);
   WN.server_uri='/lat='+position.coords.latitude
                 +'/lon='+position.coords.longitude
                 +'/alt='+position.coords.altitude
                 +'/speed='+position.coords.speed
                 +'/time='+position.timestamp
                 +'/';
};
WN.geo_error=function (error) {
   var msg='code: '+ error.code+ ', message: ' + error.message;
   WN.debug(msg);         
};



// Wait for Cordova to load
document.addEventListener("deviceready", WN.init_phonegap, false);

   </script>
 </head>
 <body>
 <h1>Web News</h1>
 
<div id="device-info">device info...</div>
<div id="debug-info">debug info...</div>
 </body>
</html>
